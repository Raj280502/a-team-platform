<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Code Factory - Web IDE</title>
    
    <!-- Monaco Editor -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/editor/editor.main.min.css">
    
    <!-- Xterm.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .header {
            background: #2d2d30;
            padding: 10px 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 {
            font-size: 18px;
            color: #ffffff;
            margin-right: auto;
        }

        .prompt-input {
            flex: 1;
            max-width: 500px;
            padding: 8px 12px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 14px;
        }

        .btn {
            padding: 8px 16px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #1177bb;
        }

        .btn:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .status {
            padding: 4px 12px;
            background: #2d2d30;
            border-radius: 4px;
            font-size: 13px;
        }

        .status.running {
            background: #f59e0b;
            color: #000;
        }

        .status.completed {
            background: #10b981;
            color: #000;
        }

        .status.error {
            background: #ef4444;
            color: #fff;
        }

        .connection-status {
            padding: 4px 12px;
            background: #555;
            border-radius: 4px;
            font-size: 12px;
        }

        .connection-status.connected {
            background: #10b981;
            color: #000;
        }

        /* Main Layout */
        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #252526;
            border-right: 1px solid #3e3e42;
            overflow-y: auto;
        }

        /* Preview Panel */
        .preview-panel {
            width: 400px;
            background: #252526;
            border-left: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            padding: 10px 15px;
            background: #2d2d30;
            font-size: 13px;
            font-weight: 600;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preview-url {
            flex: 1;
            padding: 4px 8px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 3px;
            color: #d4d4d4;
            font-size: 12px;
            font-family: monospace;
        }

        .preview-iframe {
            flex: 1;
            border: none;
            background: white;
        }

        .preview-placeholder {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 14px;
            text-align: center;
            padding: 20px;
        }

        .sidebar-header {
            padding: 10px 15px;
            background: #2d2d30;
            font-size: 13px;
            font-weight: 600;
            border-bottom: 1px solid #3e3e42;
        }

        .file-tree {
            padding: 10px 0;
        }

        .file-item {
            padding: 6px 15px 6px 25px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-item:hover {
            background: #2a2d2e;
        }

        .file-item.active {
            background: #094771;
            color: #ffffff;
        }

        /* Content Area */
        .content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            overflow-x: auto;
        }

        .tab {
            padding: 8px 20px;
            background: #2d2d30;
            border-right: 1px solid #3e3e42;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }

        .tab.active {
            background: #1e1e1e;
            color: #ffffff;
        }

        .tab:hover {
            background: #2a2d2e;
        }

        /* Editor and Terminal */
        .editor-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #editor {
            width: 100%;
            height: 100%;
        }

        .terminal-container {
            height: 250px;
            background: #1e1e1e;
            border-top: 1px solid #3e3e42;
            padding: 10px;
        }

        #terminal {
            width: 100%;
            height: 100%;
        }

        /* Resizer */
        .resizer {
            height: 4px;
            background: #3e3e42;
            cursor: ns-resize;
        }

        .resizer:hover {
            background: #007acc;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üè≠ AI Code Factory</h1>
            <input 
                type="text" 
                id="promptInput" 
                class="prompt-input" 
                placeholder="Describe your app (e.g., 'todo app', 'calculator')..."
            >
            <button id="generateBtn" class="btn">Generate</button>
            <span id="statusBadge" class="status">Ready</span>
            <span id="connectionStatus" class="connection-status">Connecting...</span>
        </div>

        <!-- Main Layout -->
        <div class="main">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">FILES</div>
                <div id="fileTree" class="file-tree">
                    <div style="padding: 20px; text-align: center; color: #888; font-size: 13px;">
                        No project loaded
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content">
                <!-- Tabs -->
                <div id="tabs" class="tabs">
                    <div class="tab active">Welcome</div>
                </div>

                <!-- Editor -->
                <div class="editor-container">
                    <div id="editor"></div>
                </div>

                <!-- Resizer -->
                <div class="resizer" id="resizer"></div>

                <!-- Terminal -->
                <div class="terminal-container">
                    <div id="terminal"></div>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="preview-panel">
                <div class="preview-header">
                    <span>üì± PREVIEW</span>
                    <input type="text" id="previewUrl" class="preview-url" value="http://localhost:3000" readonly>
                    <button id="refreshPreview" class="btn" style="padding: 4px 12px; font-size: 12px;" title="Refresh preview">üîÑ</button>
                    <button id="openExternal" class="btn" style="padding: 4px 12px; font-size: 12px;" title="Open in new tab" onclick="window.open(document.getElementById('previewUrl').value, '_blank')">üîó</button>
                </div>
                <div id="previewPlaceholder" class="preview-placeholder">
                    Generate a project to see live preview
                </div>
                <iframe id="previewFrame" class="preview-iframe" style="display: none;" onerror="document.getElementById('previewPlaceholder').innerHTML='‚ùå Failed to load preview. Check if Docker is running.'; document.getElementById('previewFrame').style.display='none'; document.getElementById('previewPlaceholder').style.display='flex';"></iframe>
            </div>
        </div>
    </div>

    <!-- Socket.IO - Load FIRST to avoid AMD conflicts -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <!-- Xterm.js -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    
    <!-- Monaco Editor - Load LAST (uses AMD loader) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>

    <script>
        // Initialize Socket.IO FIRST
        console.log('Initializing Socket.IO...');
        const socket = io();
        let currentProjectDir = null;
        let currentFile = null;
        let openFiles = new Map();

        socket.on('connect', () => {
            console.log('‚úÖ Socket.IO connected');
            const connStatus = document.getElementById('connectionStatus');
            connStatus.textContent = 'Connected';
            connStatus.className = 'connection-status connected';
        });

        socket.on('disconnect', () => {
            console.log('‚ùå Socket.IO disconnected');
            const connStatus = document.getElementById('connectionStatus');
            connStatus.textContent = 'Disconnected';
            connStatus.className = 'connection-status';
        });

        socket.on('connect_error', (error) => {
            console.error('Socket.IO connection error:', error);
            const connStatus = document.getElementById('connectionStatus');
            connStatus.textContent = 'Connection Error';
            connStatus.className = 'connection-status';
        });

        socket.on('terminal_output', (data) => {
            console.log('Terminal output:', data.output);
            term.write(data.output);
        });

        socket.on('generation_status', (data) => {
            console.log('Generation status:', data);
            updateStatus(data.status, data.message);
            if (data.project_dir) {
                currentProjectDir = data.project_dir;
            }
            
            // Load preview when generation is completed
            if (data.status === 'completed' && data.preview_url) {
                console.log('Preview URL received:', data.preview_url);
                // Wait for Docker to fully start (15 seconds)
                setTimeout(() => {
                    loadPreview(data.preview_url);
                }, 15000);
            }
        });

        socket.on('project_ready', (data) => {
            console.log('Project ready:', data);
            currentProjectDir = data.project_dir;
            loadFileTree();
            
            // Load preview after a short delay to allow Docker to start
            setTimeout(() => {
                loadPreview(data.preview_url || 'http://localhost:3000');
            }, 5000);
        });

        function loadPreview(url) {
            console.log('Loading preview:', url);
            const iframe = document.getElementById('previewFrame');
            const placeholder = document.getElementById('previewPlaceholder');
            const urlInput = document.getElementById('previewUrl');
            
            urlInput.value = url;
            placeholder.innerHTML = 'üîÑ Waiting for app to start...<br><small>Checking ' + url + '</small>';
            
            // Poll until service is ready
            let attempts = 0;
            const maxAttempts = 30; // 30 seconds
            
            const checkHealth = setInterval(() => {
                attempts++;
                console.log(`Health check attempt ${attempts}/${maxAttempts}`);
                
                fetch(url, { method: 'HEAD', mode: 'no-cors' })
                    .then(() => {
                        console.log('‚úÖ App is ready!');
                        clearInterval(checkHealth);
                        placeholder.style.display = 'none';
                        iframe.style.display = 'block';
                        iframe.src = url;
                    })
                    .catch(() => {
                        if (attempts >= maxAttempts) {
                            console.log('‚ùå Max attempts reached');
                            clearInterval(checkHealth);
                            placeholder.innerHTML = `‚ùå Failed to connect to ${url}<br><small>Make sure Docker is running</small><br><button onclick="loadPreview('${url}')" class="btn" style="margin-top: 10px; padding: 6px 12px; font-size: 12px;">Retry</button>`;
                        }
                    });
            }, 1000);
        }

        function refreshPreview() {
            const iframe = document.getElementById('previewFrame');
            if (iframe.src) {
                iframe.src = iframe.src;
            }
        }
    </script>

    <script>
        // Initialize Monaco Editor
        let editor;
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
        
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: '// Welcome to AI Code Factory!\n// Enter a prompt above and click Generate to start.',
                language: 'javascript',
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 14,
                minimap: { enabled: false }
            });
        });

        // Initialize Terminal
        const term = new Terminal({
            cursorBlink: true,
            theme: {
                background: '#1e1e1e',
                foreground: '#d4d4d4'
            },
            fontSize: 14
        });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        term.writeln('Welcome to AI Code Factory Terminal');
        term.writeln('Type commands to execute in your project\n');

        let commandBuffer = '';
        term.onData(data => {
            if (data === '\r') {
                term.write('\r\n');
                socket.emit('execute_command', { 
                    command: commandBuffer,
                    cwd: currentProjectDir 
                });
                commandBuffer = '';
            } else if (data === '\x7F') { // Backspace
                if (commandBuffer.length > 0) {
                    commandBuffer = commandBuffer.slice(0, -1);
                    term.write('\b \b');
                }
            } else {
                commandBuffer += data;
                term.write(data);
            }
        });

        // Socket.IO
        // Already initialized above, just declare variables here
        // const socket, currentProjectDir, currentFile already exist

        // UI Functions
        function updateStatus(status, message) {
            console.log('Status update:', status, message);
            const badge = document.getElementById('statusBadge');
            badge.textContent = message;
            badge.className = `status ${status}`;
        }

        async function testServer() {
            console.log('Testing server connection...');
            try {
                const response = await fetch('/api/test');
                const data = await response.json();
                console.log('Server test result:', data);
                alert(`Server Status: ${data.status}\n${data.message}`);
            } catch (error) {
                console.error('Server test failed:', error);
                alert(`Server test failed: ${error.message}`);
            }
        }

        async function generateProject() {
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                alert('Please enter a prompt');
                return;
            }

            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.textContent = 'Generating...';

            console.log('Starting generation with prompt:', prompt);

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Generation started:', data);
                updateStatus('running', data.message);
            } catch (error) {
                console.error('Generation error:', error);
                updateStatus('error', `Error: ${error.message}`);
                btn.disabled = false;
                btn.textContent = 'Generate';
            }
        }

        async function loadFileTree() {
            try {
                const response = await fetch('/api/project/files');
                const data = await response.json();
                
                const fileTree = document.getElementById('fileTree');
                fileTree.innerHTML = '';
                
                data.files.forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'file-item';
                    item.textContent = file;
                    item.onclick = () => openFile(file);
                    fileTree.appendChild(item);
                });

                document.getElementById('generateBtn').disabled = false;
                document.getElementById('generateBtn').textContent = 'Generate';
            } catch (error) {
                console.error('Failed to load files:', error);
            }
        }

        async function openFile(filepath) {
            try {
                const response = await fetch(`/api/files/${filepath}`);
                const data = await response.json();
                
                // Detect language from extension
                const ext = filepath.split('.').pop();
                const langMap = {
                    'py': 'python',
                    'js': 'javascript',
                    'jsx': 'javascript',
                    'ts': 'typescript',
                    'tsx': 'typescript',
                    'html': 'html',
                    'css': 'css',
                    'json': 'json',
                    'md': 'markdown'
                };
                const language = langMap[ext] || 'plaintext';
                
                monaco.editor.setModelLanguage(editor.getModel(), language);
                editor.setValue(data.content);
                currentFile = filepath;

                // Update active file in sidebar
                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.toggle('active', item.textContent === filepath);
                });
            } catch (error) {
                console.error('Failed to load file:', error);
                updateStatus('error', `Failed to load ${filepath}`);
            }
        }

        async function saveCurrentFile() {
            if (!currentFile) return;

            try {
                const content = editor.getValue();
                await fetch(`/api/files/${currentFile}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                updateStatus('completed', `Saved ${currentFile}`);
                setTimeout(() => updateStatus('idle', 'Ready'), 2000);
            } catch (error) {
                updateStatus('error', `Failed to save ${currentFile}`);
            }
        }

        // Event Listeners
        console.log('Setting up event listeners...');
        
        document.getElementById('generateBtn').addEventListener('click', (e) => {
            console.log('Generate button clicked!');
            e.preventDefault();
            generateProject();
        });
        
        document.getElementById('promptInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                console.log('Enter pressed in prompt input');
                e.preventDefault();
                generateProject();
            }
        });

        document.getElementById('refreshPreview').addEventListener('click', refreshPreview);

        // Auto-save on Ctrl+S
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveCurrentFile();
            }
        });

        // Terminal resizing
        let isResizing = false;
        document.getElementById('resizer').addEventListener('mousedown', () => {
            isResizing = true;
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const terminalContainer = document.querySelector('.terminal-container');
            const newHeight = window.innerHeight - e.clientY;
            if (newHeight > 100 && newHeight < 600) {
                terminalContainer.style.height = newHeight + 'px';
                fitAddon.fit();
            }
        });

        document.addEventListener('mouseup', () => {
            isResizing = false;
        });

        // Resize editor/terminal on window resize
        window.addEventListener('resize', () => {
            fitAddon.fit();
        });
    </script>
</body>
</html>
